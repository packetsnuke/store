(function() {  "use strict";

  /**
   * WooCommerce PDF Product Vouchers admin scripts
   *
   * @since 3.0.0
   */
  jQuery(function($) {
    var ModalView, VoucherImageFrame, blockui_options, copy_purchaser_details, file_frame, file_frame_images, handle_balance_response, handle_redeem_form_submit, handle_void_form_submit, init_tiptip, load_customer_details, pagenow, pdf_vouchers, ref, ref1, ref2, show_modal, toggle_voucher_panels, typenow, validate_redemption_value, voucher_product;
    pdf_vouchers = (ref = window.wc_pdf_product_vouchers_admin) != null ? ref : {};
    typenow = (ref1 = window.typenow) != null ? ref1 : '';
    pagenow = (ref2 = window.pagenow) != null ? ref2 : '';

    /**
    	 * Initialize tooltips
    	 *
    	 * @since 3.0.0
     */
    init_tiptip = function() {
      return $(document.body).trigger('init_tooltips');
    };

    /**
    	 * Voucher edit & list screens
     */
    if ('wc_voucher' === pagenow || 'edit-wc_voucher' === pagenow) {
      init_tiptip();
      $('.page-title-action, .add-new-h2').on('click', function(event) {
        event.preventDefault();
        return $(this).pointer('toggle');
      }).on('pointercreate', function() {
        var $el, $pointer;
        $el = $(this);
        $pointer = $el.data('wp-pointer').pointer;
        $pointer.on('click', '.close', function(event) {
          event.preventDefault();
          return $el.pointer('close');
        });
        return $pointer.on('click', '.button-primary', function(event) {
          event.preventDefault();
          return $pointer.find('form').submit();
        });
      }).on('pointeropened', function(event, t) {
        t.pointer.find('input:first').focus();
        return $(document.body).trigger('wc-enhanced-select-init');
      }).pointer({
        pointerClass: 'create-voucher-pointer',
        content: function() {
          var fields, form;
          if (pdf_vouchers.is_wc_version_gte_3_0) {
            fields = '<p><label for="search_product_id">' + pdf_vouchers.i18n.product + '</label><select class="wc-product-search" name="product" id="search_product_id" style="width:100%" data-exclude="wc_pdf_product_vouchers_non_voucher_products" data-placeholder="' + pdf_vouchers.i18n.search_for_product + '" data-allow_clear="true" ></select></p> <p><label for="search_product_id">' + pdf_vouchers.i18n.purchaser + '</label><select class="wc-customer-search" name="customer" id="search_customer_id" style="width:100%" data-placeholder="' + pdf_vouchers.i18n.guest + '" data-allow_clear="true" ></select></p>';
          } else {
            fields = '<p><input type="hidden" class="wc-product-search" name="product" id="search_product_id" style="width:100%" data-exclude="wc_pdf_product_vouchers_non_voucher_products" data-placeholder="' + pdf_vouchers.i18n.search_for_product + '" data-allow_clear="true" /></p> <p><input type="hidden" class="wc-customer-search" name="customer" id="search_customer_id" style="width:100%" data-placeholder="' + pdf_vouchers.i18n.guest + '" data-allow_clear="true" /></p>';
          }
          form = '<form method="get" action="' + pdf_vouchers.new_voucher_url + '"> <input type="hidden" name="post_type" value="wc_voucher" /> <h3 class="wc-pdf-product-vouchers-voucher-create-voucher">' + pdf_vouchers.i18n.select_product_and_purchaser + '</h3>' + fields + '</form>';
          return form;
        },
        buttons: function() {
          return $('<div> <a class="close wc-pdf-product-vouchers-redeem-voucher-pointer-close" href="#">' + pdf_vouchers.i18n.cancel + '</a> <button class="button button-primary">' + pdf_vouchers.i18n.add_voucher + '</button> </div>');
        }
      });
    }

    /**
    	 * Voucher edit screen
     */
    if ('wc_voucher' === pagenow) {
      $('.date-picker-field, .date-picker').datepicker({
        dateFormat: 'yy-mm-dd',
        numberOfMonths: 1,
        showButtonPanel: true
      });
      voucher_product = null;
      blockui_options = {
        message: null,
        overlayCSS: {
          background: '#fff',
          opacity: 0.6
        }
      };
      ModalView = $.WCBackboneModal.View;

      /**
      		 * Show a modal, closing any previously open modals
      		 *
      		 * @since 3.0.0
      		 * @param {string} template_id Modal template id
      		 * @param {object} template_data Data for the modal template
       */
      show_modal = function(template_id, template_data) {
        $('#wc-backbone-modal-dialog .modal-close').trigger('click');
        return new ModalView({
          target: template_id,
          string: template_data
        });
      };

      /**
      		 * Load puchaser (customer) details via AJAX
      		 *
      		 * @since 3.0.0
       */
      load_customer_details = function() {
        var data, user_id;
        user_id = $('#customer_id').val();
        if (!user_id) {
          window.alert(pdf_vouchers.i18n.no_customer_selected);
          return false;
        }
        data = {
          user_id: user_id,
          action: 'wc_pdf_product_vouchers_get_customer_details',
          security: pdf_vouchers.get_customer_details_nonce
        };
        $('.voucher-purchaser-details div.edit-details').block(blockui_options);
        return $.get(wc_pdf_product_vouchers_admin.ajax_url, data, function(response) {
          if (response.success) {
            $.each(response.data, function(key, data) {
              return $(':input#_purchaser_' + key).val(data).change();
            });
          }
          return $('.voucher-purchaser-details div.edit-details').unblock();
        });
      };

      /**
      		 * Copy purchaser details to recipient details
      		 *
      		 * @since 3.0.0
       */
      copy_purchaser_details = function() {
        return $('.voucher-purchaser-details :input[name^="_purchaser_"]').each(function() {
          var input_name;
          input_name = $(this).attr('name');
          input_name = input_name.replace('_purchaser_', '_recipient_');
          return $(':input#' + input_name).val($(this).val()).change();
        });
      };

      /**
      		 * Voucher Image Media Frame
      		 *
      		 * @since 3.0.0
       */
      VoucherImageFrame = wp.media.view.MediaFrame.Select.extend({
        browseRouter: function(routerView) {
          return routerView.set({
            browse: {
              text: _wpMediaViewsL10n.mediaLibraryTitle,
              priority: 20
            }
          });
        }
      });
      $(document.body).on('wc_backbone_modal_loaded', function(e, target) {
        if ('wc-voucher-modal-edit-product' !== target) {
          return;
        }
        $(document.body).trigger('wc-enhanced-select-init');
        return $(document.body).on('change.edit-product-modal', '#voucher_product_id', function(event) {
          var data;
          $('#modal_voucher_product_price').closest('p').block(blockui_options);
          data = {
            action: 'wc_pdf_product_vouchers_get_product_details',
            product_id: event.target.value,
            security: wc_pdf_product_vouchers_admin.get_product_details_nonce
          };
          return $.get(wc_pdf_product_vouchers_admin.ajax_url, data, function(response) {
            var formatted_price;
            if (response.success && response.data) {
              voucher_product = response.data;
              formatted_price = window.accounting.format(voucher_product.price, 2, null, woocommerce_admin.mon_decimal_point);
              return $('#modal_voucher_product_price').val(formatted_price).closest('p').unblock();
            }
          });
        });
      }).on('wc_backbone_modal_removed', function(e, target) {
        if ('wc-voucher-modal-edit-product' !== target) {
          return;
        }
        return $(document.body).off('change.edit-product-modal');
      }).on('wc_backbone_modal_response', function(event, target, posted_data) {
        var data;
        $('#wc-pdf-product-vouchers-voucher-balance').block(blockui_options);
        data = {
          action: 'wc_pdf_product_vouchers_update_voucher_product',
          security: wc_pdf_product_vouchers_admin.update_voucher_product_nonce,
          voucher_id: $('#post_ID').val(),
          product_id: posted_data.product_id,
          product_price: posted_data.product_price
        };
        return $.post(wc_pdf_product_vouchers_admin.ajax_url, data, function(response) {
          if (response.success && response.data) {
            $('#wc-pdf-product-vouchers-voucher-balance .inside').html(response.data.balance_html);
            if (response.data.preview_html) {
              $('#wc-pdf-product-vouchers-voucher-preview .inside').html(response.data.preview_html);
            }
            init_tiptip();
          }
          return $('#wc-pdf-product-vouchers-voucher-balance').unblock();
        });
      }).on('keyup', '.js-wc-pdf-vouchers-redeem-amount', function() {
        var product_price, remaining_value, voucher_type;
        remaining_value = $('#voucher_remaining_value_for_display').val();
        product_price = $('#voucher_product_price_for_display').val();
        voucher_type = $('#voucher_type').val();
        return validate_redemption_value($(this), remaining_value, product_price, voucher_type);
      }).on('blur', '.js-wc-pdf-vouchers-redeem-amount', function() {
        return $('.wc_error_tip').fadeOut('100', function() {
          return $(this).remove();
        });
      });
      $('a.edit-voucher-details').on('click', function(e) {
        e.preventDefault();
        $(this).hide();
        $(this).parent().find('a:not(.edit-voucher-details)').show();
        $(this).closest('.voucher_data_column').find('div.view-details').hide();
        return $(this).closest('.voucher_data_column').find('div.edit-details').show();
      });
      $('a.load-customer-details').on('click', function(e) {
        e.preventDefault();
        if (window.confirm(pdf_vouchers.i18n.confirm_load_customer_details)) {
          return load_customer_details();
        }
      });
      $('a.copy-purchaser-details').on('click', function(e) {
        e.preventDefault();
        if (window.confirm(pdf_vouchers.i18n.confirm_copy_purchaser_details)) {
          return copy_purchaser_details();
        }
      });
      $('#customer_id').data('original_customer_id', $('#customer_id').val()).on('change', function() {
        if ($(this).val() !== $(this).data('original_customer_id')) {
          $('button.js-calculate-tax-action, button.js-redeem-action').prop('disabled', true);
          return $('.js-customer-changed-notice').show();
        } else {
          $('button.js-calculate-tax-action, button.js-redeem-action').prop('disabled', false);
          return $('.js-customer-changed-notice').hide();
        }
      }).change();
      $('#wc-pdf-product-vouchers-voucher-notes').on('click', '.js-add-note', function(e) {
        var data, note;
        e.preventDefault();
        note = $('textarea#voucher-note').val();
        if (!note) {
          return;
        }
        $('#wc-pdf-product-vouchers-voucher-notes').block(blockui_options);
        data = {
          action: 'wc_pdf_product_vouchers_add_voucher_note',
          voucher_id: $('#post_ID').val(),
          note: note,
          notify: $('#note-notify').is(':checked'),
          security: wc_pdf_product_vouchers_admin.add_voucher_note_nonce
        };
        return $.post(wc_pdf_product_vouchers_admin.ajax_url, data, function(response) {
          if (response.success && response.data) {
            $('ul.voucher-notes').prepend(response.data.note_html).find('ul.no-notes').hide();
          }
          $('#wc-pdf-product-vouchers-voucher-notes').unblock();
          return $('textarea#voucher-note').val('');
        });
      }).on('click', 'a.js-delete-note', function(e) {
        var data, note;
        e.preventDefault();
        note = $(this).closest('li.note');
        $(note).block(blockui_options);
        data = {
          action: 'wc_pdf_product_vouchers_delete_voucher_note',
          note_id: $(note).attr('rel'),
          security: wc_pdf_product_vouchers_admin.delete_voucher_note_nonce
        };
        return $.post(wc_pdf_product_vouchers_admin.ajax_url, data, function(response) {
          $(note).remove();
          if ($('ul.voucher-notes').find('li:not(.no-notes)').length < 1) {
            return $('ul.voucher-notes').find('li.no-notes').show();
          }
        });
      });
      $('#wc-pdf-product-vouchers-voucher-balance').on('click', '.js-edit-voucher-product', function(event) {
        event.preventDefault();
        return show_modal('wc-voucher-modal-edit-product', {
          product_id: $('input[name="_product_id"]').val(),
          product_title: $('.product .wc-voucher-item-name').text(),
          product_price: $('input[name="_product_price"]').val()
        });
      }).on('click', '.js-edit-voucher-redemption', function(event) {
        event.preventDefault();
        $(this).closest('tr').find('.view').hide();
        $(this).closest('tr').find('.edit').show();
        $('div.wc-voucher-data-row.wc-voucher-edit-redemption-actions').slideDown();
        $('div.wc-voucher-data-row-toggle').not('div.wc-voucher-data-row.wc-voucher-edit-redemption-actions').slideUp();
        $('div.wc-voucher-data-row.wc-voucher-edit-redemption-actions button.js-cancel-action').attr('data-reload', true);
        $('div.wc-voucher-totals-wrapper').slideDown();
        return $(this).hide();
      }).on('click', '.js-redeem-action', function(event) {
        event.preventDefault();
        $('div.wc-voucher-data-row.wc-voucher-redeem-actions').slideDown();
        $('div.wc-voucher-data-row-toggle').not('div.wc-voucher-data-row.wc-voucher-redeem-actions').slideUp();
        $('div.wc-voucher-totals-wrapper').slideUp();
        $('div.wc-voucher-redeem-wrapper').slideDown();
        return $('.edit-voucher-item').hide();
      }).on('click', '.js-void-action', function(event) {
        event.preventDefault();
        $('div.wc-voucher-data-row.wc-voucher-void-actions').slideDown();
        $('div.wc-voucher-data-row-toggle').not('div.wc-voucher-data-row.wc-voucher-void-actions').slideUp();
        $('div.wc-voucher-totals-wrapper').slideUp();
        $('div.wc-voucher-void-wrapper').slideDown();
        return $('.edit-voucher-item').hide();
      }).on('click', '.js-calculate-tax-action', function(event) {
        var data;
        event.preventDefault();
        if (!window.confirm(pdf_vouchers.i18n.confirm_calculate_taxes)) {
          return;
        }
        $('#wc-pdf-product-vouchers-voucher-balance').block(blockui_options);
        data = {
          action: 'wc_pdf_product_vouchers_calculate_voucher_product_tax',
          security: wc_pdf_product_vouchers_admin.voucher_balance_nonce,
          voucher_id: $('#post_ID').val()
        };
        return $.post(wc_pdf_product_vouchers_admin.ajax_url, data, handle_balance_response);
      }).on('click', '.js-delete-voucher-redemption', function(event) {
        var data;
        event.preventDefault();
        if (!window.confirm(pdf_vouchers.i18n.confirm_delete_redemption)) {
          return;
        }
        $('#wc-pdf-product-vouchers-voucher-balance').block(blockui_options);
        data = {
          action: 'wc_pdf_product_vouchers_delete_voucher_redemption',
          security: wc_pdf_product_vouchers_admin.voucher_balance_nonce,
          voucher_id: $('#post_ID').val(),
          redemption_key: $(event.target).closest('tr').data('key')
        };
        return $.post(wc_pdf_product_vouchers_admin.ajax_url, data, handle_balance_response);
      }).on('click', '.js-cancel-action', function(event) {
        var $button, data;
        $('div.wc-voucher-data-row-toggle').not('div.wc-voucher-balance-actions').slideUp();
        $('div.wc-voucher-balance-actions').slideDown();
        $('div.wc-voucher-totals-wrapper').slideDown();
        $('.edit-voucher-item').show();
        $button = $(this);
        if ('true' === $button.attr('data-reload')) {
          $('#wc-pdf-product-vouchers-voucher-balance').block(blockui_options);
          data = {
            action: 'wc_pdf_product_vouchers_load_voucher_redemptions',
            security: wc_pdf_product_vouchers_admin.voucher_balance_nonce,
            voucher_id: $('#post_ID').val()
          };
          return $.post(wc_pdf_product_vouchers_admin.ajax_url, data, function(response) {
            if (response.success && response.data) {
              $('tbody#voucher-redemptions').replaceWith(response.data.redemptions_html);
              init_tiptip();
              $button.attr('data-reload', 'false');
            }
            return $('#wc-pdf-product-vouchers-voucher-balance').unblock();
          });
        }
      }).on('click', '.js-redeem-voucher-action', function(event) {
        var data, redemption_amount, tax_ratio;
        event.preventDefault();
        redemption_amount = $('#redemption_amount').val();
        if ('incl' === wc_pdf_product_vouchers_admin.tax_display_shop && $('#voucher_tax').val()) {
          tax_ratio = $('#voucher_tax').val() / $('#voucher_value').val();
          redemption_amount = redemption_amount / (1 + tax_ratio);
        }
        data = {
          action: 'wc_pdf_product_vouchers_redeem_voucher',
          security: wc_pdf_product_vouchers_admin.voucher_balance_nonce,
          voucher_id: $('#post_ID').val(),
          amount: redemption_amount,
          notes: $('#redemption_notes').val()
        };
        $('#wc-pdf-product-vouchers-voucher-balance').block(blockui_options);
        return $.post(wc_pdf_product_vouchers_admin.ajax_url, data, handle_balance_response);
      }).on('click', '.js-void-voucher-action', function(event) {
        var data;
        event.preventDefault();
        if (!window.confirm(pdf_vouchers.i18n.confirm_void_voucher)) {
          return;
        }
        $('#wc-pdf-product-vouchers-voucher-balance').block(blockui_options);
        data = {
          action: 'wc_pdf_product_vouchers_void_voucher',
          security: wc_pdf_product_vouchers_admin.voucher_balance_nonce,
          voucher_id: $('#post_ID').val(),
          reason: $('#void_reason').val()
        };
        return $.post(wc_pdf_product_vouchers_admin.ajax_url, data, handle_balance_response);
      }).on('click', '.js-restore-action', function(event) {
        var data;
        event.preventDefault();
        if (!window.confirm(pdf_vouchers.i18n.confirm_restore_voucher)) {
          return;
        }
        $('#wc-pdf-product-vouchers-voucher-balance').block(blockui_options);
        data = {
          action: 'wc_pdf_product_vouchers_restore_voucher',
          security: wc_pdf_product_vouchers_admin.voucher_balance_nonce,
          voucher_id: $('#post_ID').val()
        };
        return $.post(wc_pdf_product_vouchers_admin.ajax_url, data, handle_balance_response);
      }).on('click', '.js-save-redemptions-action', function(event) {
        var data, fields, tax_ratio;
        event.preventDefault();
        fields = $('tbody#voucher-redemptions :input[name]').serializeArray();
        if ('incl' === wc_pdf_product_vouchers_admin.tax_display_shop && $('#voucher_tax').val()) {
          tax_ratio = $('#voucher_tax').val() / $('#voucher_value').val();
          fields.forEach(function(field, i) {
            if (field.name.lastIndexOf('[amount]') > 0) {
              return fields[i].value = field.value / (1 + tax_ratio);
            }
          });
        }
        data = {
          action: 'wc_pdf_product_vouchers_save_voucher_redemptions',
          security: wc_pdf_product_vouchers_admin.voucher_balance_nonce,
          voucher_id: $('#post_ID').val(),
          data: $.param(fields)
        };
        $('#wc-pdf-product-vouchers-voucher-balance').block(blockui_options);
        return $.post(wc_pdf_product_vouchers_admin.ajax_url, data, handle_balance_response);
      });
      file_frame = null;
      file_frame_images = $('#_voucher_image_options').val();
      $('#wc-pdf-product-vouchers-voucher-preview').on('click', '.js-select-voucher-image', function(event) {
        var images, l10n;
        event.preventDefault();
        l10n = _wpMediaViewsL10n;
        images = $('#_voucher_image_options').val();
        if (file_frame && file_frame_images === images) {
          file_frame.open();
          return;
        }
        file_frame_images = images;
        file_frame = new VoucherImageFrame({
          button: {
            text: l10n.chooseImage
          },
          states: new wp.media.controller.Library({
            title: l10n.chooseImage,
            library: wp.media.query({
              type: 'image',
              include: file_frame_images.split(',')
            }),
            multiple: false,
            searchable: false,
            date: false,
            content: 'browse'
          })
        });
        file_frame.on('open', function() {
          var selected, selection;
          selection = file_frame.state().get('selection');
          selected = $('#_thumbnail_id').val();
          return selection.add(wp.media.attachment(selected));
        });
        file_frame.on('select', function() {
          var data, selection;
          selection = file_frame.state().get('selection').first().toJSON();
          if (!(selection && selection.id)) {
            return;
          }
          data = {
            voucher_id: $('#post_ID').val(),
            image_id: selection.id,
            action: 'wc_pdf_product_vouchers_get_voucher_preview',
            security: pdf_vouchers.get_voucher_preview_nonce
          };
          $('#wc-pdf-product-vouchers-voucher-preview .inside').block(blockui_options);
          return $.get(wc_pdf_product_vouchers_admin.ajax_url, data, function(response) {
            if (response.success) {
              $('#wc-pdf-product-vouchers-voucher-preview .inside').html(response.data.preview_html);
            }
            return $('#wc-pdf-product-vouchers-voucher-preview .inside').unblock();
          });
        });
        return file_frame.open();
      });
    }

    /**
    	 * Voucher list screen (counter-intuitively, edit-wc_voucher is actually the list screen)
     */
    if ('edit-wc_voucher' === pagenow) {
      $('.redeem').on('click', function(event) {
        event.preventDefault();
        return $(this).pointer('toggle');
      }).on('pointercreate', function() {
        var $el, $pointer, product_price, remaining_value, tax, value, voucher_type;
        $el = $(this);
        $pointer = $el.data('wp-pointer').pointer;
        voucher_type = $el.closest('.voucher_actions').find('.voucher-type').val();
        product_price = $el.closest('.voucher_actions').find('.voucher-product-price-for-display').val();
        value = $el.closest('.voucher_actions').find('.voucher-value').val();
        tax = $el.closest('.voucher_actions').find('.voucher-tax').val();
        remaining_value = $el.closest('.voucher_actions').find('.voucher-remaining-value-for-display').val();
        $pointer.data('voucher-type', voucher_type);
        $pointer.data('voucher-product-price', product_price);
        $pointer.data('voucher-value', value);
        $pointer.data('voucher-tax', tax);
        $pointer.data('voucher-remaining-value', remaining_value);
        $pointer.on('submit', 'form', function(event) {
          event.preventDefault();
          return handle_redeem_form_submit($pointer);
        });
        $pointer.on('click', '.button-primary', function(event) {
          event.preventDefault();
          return handle_redeem_form_submit($pointer);
        });
        return $pointer.on('click', '.close', function(event) {
          event.preventDefault();
          return $el.pointer('close');
        });
      }).on('pointeropened', function(event, t) {
        return t.pointer.find('input:first').focus();
      }).pointer({
        pointerClass: 'redeem-voucher-pointer',
        position: {
          edge: 'top',
          at: 'center bottom',
          my: 'right+63 top'
        },
        content: function() {
          var $el, remaining_value, url;
          $el = $(this);
          url = $el.attr('href');
          remaining_value = $el.closest('p').find('.voucher-remaining-value-for-display').val();
          return '<form method="get" action="' + url + '"> <h3 class="wc-pdf-product-vouchers-voucher-redeem-voucher">' + pdf_vouchers.i18n.redeem_voucher + '</h3> <p> <label>' + pdf_vouchers.i18n.amount_label + '<input type="text" name="amount" class="large-text js-wc-pdf-vouchers-redeem-amount" value="' + window.accounting.format(remaining_value, 2, null, woocommerce_admin.mon_decimal_point) + '" /> </label> </p> <p> <label>' + pdf_vouchers.i18n.notes_label + '<textarea name="notes" class="large-text"></textarea> </label> </p> </form>';
        },
        buttons: function() {
          return $('<div> <a class="close wc-pdf-product-vouchers-redeem-voucher-pointer-close" href="#">' + pdf_vouchers.i18n.cancel + '</a> <button class="button button-primary">' + pdf_vouchers.i18n.redeem + '</button> </div>');
        }
      });
      $(document.body).on('keyup', '.js-wc-pdf-vouchers-redeem-amount', function() {
        var $pointer;
        $pointer = $(this).closest('.redeem-voucher-pointer');
        return validate_redemption_value($(this), $pointer.data('voucher-remaining-value'), $pointer.data('voucher-product-price'), $pointer.data('voucher-type'));
      }).on('blur', '.js-wc-pdf-vouchers-redeem-amount', function() {
        return $('.wc_error_tip').fadeOut('100', function() {
          return $(this).remove();
        });
      });
      $('.void').on('click', function(event) {
        event.preventDefault();
        return $(this).pointer('toggle');
      }).on('pointercreate', function() {
        var $el, $pointer;
        $el = $(this);
        $pointer = $el.data('wp-pointer').pointer;
        $pointer.on('submit', 'form', function(event) {
          event.preventDefault();
          return handle_void_form_submit($pointer);
        });
        $pointer.on('click', '.button-primary', function(event) {
          event.preventDefault();
          return setTimeout(function() {
            return handle_void_form_submit($pointer);
          }, 0);
        });
        return $pointer.on('click', '.close', function(event) {
          event.preventDefault();
          return $el.pointer('close');
        });
      }).on('pointeropened', function(event, t) {
        return t.pointer.find('input:first').focus();
      }).pointer({
        pointerClass: 'void-voucher-pointer',
        position: {
          edge: 'top',
          at: 'center bottom',
          my: 'right+63 top'
        },
        content: function() {
          var $el, remaining_value, url;
          $el = $(this);
          url = $el.attr('href');
          remaining_value = $el.closest('p').find('.voucher-remaining-value').val();
          return '<form method="get" action="' + url + '"> <h3 class="wc-pdf-product-vouchers-voucher-void-voucher">' + pdf_vouchers.i18n.void_remaining_value + '</h3> <p> <label>' + pdf_vouchers.i18n.reason_label + '<textarea name="notes" class="large-text"></textarea> </label> </p> </form>';
        },
        buttons: function() {
          return $('<div> <a class="close wc-pdf-product-vouchers-void-voucher-pointer-close" href="#">' + pdf_vouchers.i18n.cancel + '</a> <button class="button button-primary">' + pdf_vouchers.i18n["void"] + '</button> </div>');
        }
      });
    }

    /**
    	 * Product Edit screen
     */
    if ('product' === pagenow) {
      toggle_voucher_panels = function() {
        var has_voucher;
        has_voucher = $('input#_has_voucher:checked').length;
        $('.hide_if_has_voucher').show();
        $('.show_if_has_voucher').hide();
        if (has_voucher) {
          return $('.show_if_has_voucher').show();
        }
      };
      $(document.body).on('woocommerce-product-type-change', function(event, type) {
        if ('variable' === type || 'grouped' === type || 'external' === type || 'variable-subscription' === type) {
          $('input#_has_voucher').prop('checked', false).change();
        }
        return toggle_voucher_panels();
      });
      $('input#_has_voucher').on('change', function() {
        return toggle_voucher_panels();
      });
      $('input#_has_voucher').change();
      $('#variable_product_options').on('change', 'input.variable_has_voucher', function() {
        $(this).closest('.woocommerce_variation').find('.show_if_variation_has_voucher').hide();
        if ($(this).is(':checked')) {
          return $(this).closest('.woocommerce_variation').find('.show_if_variation_has_voucher').show();
        }
      });
      $('input.variable_has_voucher').change();
      $('#woocommerce-product-data').on('woocommerce_variations_loaded', function(event, needsUpdate) {
        needsUpdate = needsUpdate || false;
        if (!needsUpdate) {
          return $('input.variable_has_voucher').change();
        }
      });
    }
    $.extend(woocommerce_admin, {
      pdf_product_vouchers_i18n_amount_greater_than_zero_error: pdf_vouchers.i18n.amount_greater_than_zero_error,
      pdf_product_vouchers_i18n_amount_less_or_equal_to_remaining_error: pdf_vouchers.i18n.amount_less_or_equal_to_remaining_error,
      pdf_product_vouchers_i18n_amount_multiple_of_product_price_error: pdf_vouchers.i18n.amount_multiple_of_product_price_error
    });

    /**
    	 * Validate redemption value
    	 *
    	 * @since 3.0.0
    	 * @param {object} $el the input element to validate
    	 * @param {float} remaining_value remaining voucher value
    	 * @param {float} product_price (optional) the voucher product price, used to validate single-purpose voucher redemption values
    	 * @param {string} voucher_type (optional) the voucher type, defaults to 'multi'
    	 * @return bool true if valid, false otherwise
     */
    validate_redemption_value = function($el, remaining_value, product_price, voucher_type) {
      var amount, invalid, newvalue, regex, valid, validations, value;
      if (product_price == null) {
        product_price = null;
      }
      if (voucher_type == null) {
        voucher_type = 'multi';
      }
      regex = new RegExp('[^0-9\\' + woocommerce_admin.mon_decimal_point + ']+', 'gi');
      value = $el.val();
      newvalue = value.replace(regex, '');
      amount = parseFloat(window.accounting.unformat(value, woocommerce_admin.mon_decimal_point));
      validations = [
        {
          error: 'i18n_mon_decimal_error',
          invalid: value !== newvalue
        }, {
          error: 'pdf_product_vouchers_i18n_amount_multiple_of_product_price_error',
          invalid: 'single' === voucher_type && amount % product_price
        }, {
          error: 'pdf_product_vouchers_i18n_amount_greater_than_zero_error',
          invalid: !amount || amount < 0
        }, {
          error: 'pdf_product_vouchers_i18n_amount_less_or_equal_to_remaining_error',
          invalid: amount > remaining_value
        }
      ];
      invalid = validations.filter(function(rule) {
        return rule.invalid;
      });
      valid = validations.filter(function(rule) {
        return !rule.invalid;
      });
      valid.forEach(function(rule) {
        if (invalid.length) {
          return $el.parent().find('.wc_error_tip.' + rule.error).remove();
        } else {
          return $(document.body).triggerHandler('wc_remove_error_tip', [$el, rule.error]);
        }
      });
      if (invalid.length) {
        $(document.body).triggerHandler('wc_add_error_tip', [$el, invalid.shift().error]);
        return false;
      }
      return true;
    };

    /**
    	 * Handle redemption form submit
    	 *
    	 * @since 3.0.0
    	 * @param {object} $pointer
     */
    handle_redeem_form_submit = function($pointer) {
      var $el;
      $el = $pointer.find('input[name="amount"]');
      return setTimeout(function() {
        var $form, data, params, tax, tax_ratio, url, value;
        if (!validate_redemption_value($el, $pointer.data('voucher-remaining-value'), $pointer.data('voucher-product-price'), $pointer.data('voucher-type'))) {
          return $el.focus();
        }
        $form = $pointer.find('form');
        url = $form.attr('action');
        value = $pointer.data('voucher-value');
        tax = $pointer.data('voucher-tax');
        data = {
          amount: $form.find('input[name="amount"]').val(),
          notes: $form.find('input[name="notes"]').val()
        };
        data.amount = parseFloat(window.accounting.unformat(data.amount, woocommerce_admin.mon_decimal_point));
        if ('incl' === wc_pdf_product_vouchers_admin.tax_display_shop && tax) {
          tax_ratio = tax / value;
          data.amount = data.amount / (1 + tax_ratio);
        }
        params = $.param(data);
        url = url + '&' + params;
        return window.location.href = url;
      });
    };

    /**
    	 * Handle void form submit
    	 *
    	 * @since 3.0.0
    	 * @param {object} $pointer
     */
    handle_void_form_submit = function($pointer) {
      var $form, data, url;
      $form = $pointer.find('form');
      url = $form.attr('action');
      data = $form.serialize();
      url = url + '&' + data;
      return window.location.href = url;
    };
    return handle_balance_response = function(response) {
      var current_status, data;
      if (typeof response === 'object' && !response.success) {
        alert(response.data.message);
      } else if (response.success && response.data) {
        data = response.data;
        $('#wc-pdf-product-vouchers-voucher-balance .inside').html(data.balance_html);
        current_status = $('#post_status').val().replace('wcpdf-', '');
        if (data.status && data.status !== current_status) {
          $('#post_status').val('wcpdf-' + data.status).change();
          if (data.notes_html) {
            $('#wc-pdf-product-vouchers-voucher-notes ul.voucher-notes').replaceWith(data.notes_html);
          }
        }
        init_tiptip();
      }
      return $('#wc-pdf-product-vouchers-voucher-balance').unblock();
    };
  });

}).call(this);


