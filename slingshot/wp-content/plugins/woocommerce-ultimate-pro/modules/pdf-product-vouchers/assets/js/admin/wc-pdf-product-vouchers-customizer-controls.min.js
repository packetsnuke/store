(function() {  "use strict";

  /**
   * WooCommerce PDF Product Voucher Templates Customizer Controls scripts
   *
   * @since 3.0.0
   */
  (function(wp, $) {
    var VoucherImagesFrame, api, init_tiptip;
    if (!wp || !wp.customize) {
      return;
    }
    api = wp.customize;

    /**
    	 * Voucher field position control
    	 *
    	 * @since 3.0.0
     */
    api.PositionControl = api.Control.extend({
      ready: function() {
        var control;
        control = this;
        _.bindAll(control, 'startPositioning', 'cancelPositioning', 'stopPositioning', 'removePosition');
        control.container.on('click keydown', '.start-button', control.startPositioning);
        control.container.on('click keydown', '.done-button', control.stopPositioning);
        control.container.on('click keydown', '.cancel-button', control.cancelPositioning);
        control.container.on('click keydown', '.remove-button', control.removePosition);
        control.state = new api.Value('default');
        control.aspectRatio = new api.Value(null);
        control.setting.bind(function(value) {
          control.params.position = value ? value.split(',') : null;
          return control.renderContent();
        });
        control.state.bind(function(value) {
          control.params.state = value;
          return control.renderContent();
        });
        api.previewer.bind('voucher:update-position:' + control.params.voucher_field_id, function(value) {
          return control.setting.set(value);
        });
        api.previewer.bind('voucher:click-position:' + control.params.voucher_field_id, function() {
          control.focus();
          return control.startPositioning();
        });
        $(document).on('keydown', function(event) {
          if (27 === event.keyCode && 'positioning' === control.state.get()) {
            control.cancelPositioning();
          }
          if (13 === event.keyCode && 'positioning' === control.state.get()) {
            return control.stopPositioning();
          }
        });
        return api.bind('save', function() {
          return control.stopPositioning();
        });
      },
      startPositioning: function() {
        var data;
        this.current_value = this.setting.get();
        this.state.set('positioning');
        data = {
          field_id: this.params.voucher_field_id,
          aspect_ratio: this.aspectRatio.get()
        };
        return api.previewer.send('voucher:start-positioning', data);
      },
      removePosition: function() {
        this.setting.set('');
        this.state.set('default');
        return api.previewer.send('voucher:remove-position', this.params.voucher_field_id);
      },
      cancelPositioning: function() {
        if (this.current_value) {
          this.setting.set(this.current_value ? this.current_value : '');
        }
        return this.stopPositioning();
      },
      stopPositioning: function() {
        this.state.set('default');
        return api.previewer.send('voucher:stop-positioning', this.params.voucher_field_id);
      }
    });

    /**
    	 * Voucher Image control
    	 *
    	 * Based on HeaderControl, with modifications to make it suitable for handling
    	 * voucher images. Uses subclassed models and views.
    	 *
    	 * @since 3.0.0
     */
    api.VoucherImageControl = api.HeaderControl.extend({
      ready: function() {
        this.btnNew = $('#customize-control-wc_pdf_product_vouchers_voucher_image .actions .new');
        _.bindAll(this, 'openMedia');
        this.btnNew.on('click', this.openMedia);
        api.HeaderTool.currentHeader = this.getInitialVoucherImage();
        new api.VoucherCurrentImageView({
          model: api.HeaderTool.currentHeader,
          el: '#customize-control-wc_pdf_product_vouchers_voucher_image .current .container'
        });
        new api.HeaderTool.ChoiceListView({
          collection: api.HeaderTool.UploadsList = new api.VoucherImageChoiceList(),
          el: '#customize-control-wc_pdf_product_vouchers_voucher_image .choices .uploaded .list'
        });
        new api.HeaderTool.ChoiceListView({
          collection: api.HeaderTool.DefaultsList = new api.VoucherImageDefaultsList(),
          el: '#customize-control-wc_pdf_product_vouchers_voucher_image .choices .default .list'
        });
        api.HeaderTool.combinedList = api.HeaderTool.CombinedList = new api.HeaderTool.CombinedList([api.HeaderTool.UploadsList, api.HeaderTool.DefaultsList]);
        wp.media.controller.Cropper.prototype.defaults.doCropArgs.wp_customize = 'on';
        return wp.media.controller.Cropper.prototype.defaults.doCropArgs.customize_theme = api.settings.theme.stylesheet;
      },
      getInitialVoucherImage: function() {
        var currentHeaderObject, primary_image;
        primary_image = api.get().wc_voucher_template_voucher_primary_image;
        if (!primary_image || !_wpCustomizeHeader.uploads[primary_image.id]) {
          return new api.VoucherImageModel();
        }
        currentHeaderObject = _wpCustomizeHeader.uploads[primary_image.id];
        return new api.VoucherImageModel({
          header: currentHeaderObject,
          choice: currentHeaderObject.url.split('/').pop()
        });
      },
      openMedia: function(event) {
        var l10n;
        l10n = _wpMediaViewsL10n;
        event.preventDefault();
        this.frame = new VoucherImagesFrame({
          button: {
            text: l10n.select,
            close: false
          },
          states: [
            new wp.media.controller.Library({
              title: l10n.chooseImage,
              library: wp.media.query({
                type: 'image'
              }),
              defaults: wp.media.query({
                type: 'image',
                include: _wpCustomizeHeader._pdf_vouchers.default_images
              }),
              multiple: false,
              date: false,
              priority: 20,
              suggestedWidth: _wpCustomizeHeader.data.width,
              suggestedHeight: _wpCustomizeHeader.data.height
            })
          ]
        });
        this.frame.on('select', this.onSelect, this);
        return this.frame.open();
      },
      onSelect: function() {
        var attachment;
        attachment = this.frame.state().get('selection').first().toJSON();
        this.setImageFromURL(attachment.url, attachment.id, attachment.width, attachment.height);
        return this.frame.close();
      },
      setImageFromURL: function(url, attachmentId, width, height) {
        var choice, data;
        data = {};
        data.url = url;
        data.thumbnail_url = url;
        data.timestamp = _.now();
        if (attachmentId) {
          data.attachment_id = attachmentId;
        }
        if (width) {
          data.width = width;
        }
        if (height) {
          data.height = height;
        }
        choice = new api.VoucherImageModel({
          header: data,
          choice: url.split('/').pop()
        });
        api.HeaderTool.UploadsList.add(choice);
        api.HeaderTool.currentHeader.set(choice.toJSON());
        choice.save();
        return choice.importImage();
      }
    });

    /**
    	 * Voucher Image Model
    	 *
    	 * @since 3.0.0
     */
    api.VoucherImageModel = api.HeaderTool.ImageModel.extend({
      destroy: function() {
        var curr, data, images, index, nextImage;
        data = this.get('header');
        curr = api.HeaderTool.currentHeader.get('header').attachment_id;
        images = _.clone(api('wc_voucher_template_voucher_images').get()) || [];
        index = images.indexOf(data.attachment_id);
        if (index > -1) {
          images.splice(index, 1);
        }
        api('wc_voucher_template_voucher_images').set(images);
        if (curr && data.attachment_id === curr) {
          nextImage = this.collection.at(1);
          if (nextImage) {
            nextImage.save();
            api.HeaderTool.currentHeader.set(nextImage.toJSON());
          } else {
            api.HeaderTool.currentHeader.trigger('hide');
          }
        }
        return this.trigger('destroy', this, this.collection);
      },
      save: function() {
        var image;
        image = this.get('header');
        api('wc_voucher_template_voucher_primary_image').set({
          id: image.attachment_id,
          src: image.url,
          width: image.width,
          height: image.height
        });
        return api.HeaderTool.combinedList.trigger('control:setImage', this);
      },
      importImage: function() {
        var data, images;
        data = this.get('header');
        if (data.attachment_id === void 0) {
          return;
        }
        images = _.clone(api('wc_voucher_template_voucher_images').get()) || [];
        images.push(data.attachment_id);
        return api('wc_voucher_template_voucher_images').set(images);
      }
    });

    /**
    	 * Voucher Image Choice List
    	 *
    	 * @since 3.0.0
     */
    api.VoucherImageChoiceList = api.HeaderTool.ChoiceList.extend({
      model: api.VoucherImageModel,
      addRandomChoice: function() {}
    });

    /**
    	 * Voucher Image Defaults List
    	 *
    	 * @since 3.0.0
     */
    api.VoucherImageDefaultsList = api.HeaderTool.DefaultsList.extend({
      model: api.VoucherImageModel,
      addRandomChoice: function() {}
    });

    /**
    	 * Current (primary) Voucher Image View
    	 *
    	 * @since 3.0.0
     */
    api.VoucherCurrentImageView = api.HeaderTool.CurrentView.extend({
      getHeight: function() {
        var height, image;
        image = this.$el.find('img');
        if (image.length) {
          this.$el.find('.inner').hide();
        } else {
          this.$el.find('.inner').show();
          return 40;
        }
        height = image.height();
        if (!height) {
          height = 'auto';
        }
        return height;
      }
    });
    $.extend(api.controlConstructor, {
      wc_pdf_product_vouchers_position: api.PositionControl,
      wc_pdf_product_vouchers_voucher_image: api.VoucherImageControl
    });

    /**
    	 * Initialize tooltips
    	 *
    	 * @since 3.0.0
     */
    init_tiptip = function() {
      $('#tiptip_holder').removeAttr('style');
      $('#tiptip_arrow').removeAttr('style');
      return $('.font-style-button').tipTip({
        'attribute': 'data-tip',
        'fadeIn': 0,
        'fadeOut': 0,
        'delay': 0
      });
    };
    $(function() {
      var $rangeSliders, set_range_text;
      init_tiptip();
      $('.customize-info .customize-panel-description').text(woocommerce_vouchers_admin_customizer.i18n.customizer_description);
      api('wc_voucher_template_post_title', function(value) {
        var initial_value;
        initial_value = value.get();
        if (!initial_value) {
          value.set('--');
          value.set('');
        }
        return value.bind(function(newval) {
          var val;
          val = newval || woocommerce_vouchers_admin_customizer.i18n.untitled_template;
          return $('.customize-info .site-title').text(val);
        });
      });
      $('#customize-control-wc_voucher_template_logo_image_id img.attachment-thumb').on('load', function() {
        var ratio;
        ratio = $(this).width() + ':' + $(this).height();
        return api.control.value('wc_voucher_template_logo_pos').aspectRatio.set(ratio);
      });
      api('wc_voucher_template_logo_image_id', function(value) {
        var pos_control;
        pos_control = api.control.value('wc_voucher_template_logo_pos');
        if (!value.get()) {
          pos_control.aspectRatio.set('');
          pos_control.state.set('');
        }
        return value.bind(function(newval) {
          if (!newval) {
            pos_control.aspectRatio.set('');
            pos_control.state.set('');
            pos_control.setting.set('');
            return api.previewer.send('voucher:remove-position', 'wc_voucher_template_logo_pos');
          } else {
            pos_control.state.set('default');
            return $('#customize-control-wc_voucher_template_logo_image_id img.attachment-thumb').on('load', function() {
              var coords, height, position, ratio, width;
              width = $(this).width();
              height = $(this).height();
              ratio = width + ':' + height;
              position = pos_control.setting.get();
              pos_control.aspectRatio.set(ratio);
              if (position) {
                coords = pos_control.setting.get().split(',').map((function(n) {
                  return parseInt(n, 10);
                }));
                coords[3] = Math.round(height / width * coords[2]);
                position = coords.join(',');
                pos_control.setting.set(position);
                return api.previewer.send('voucher:update-position', 'wc_voucher_template_logo_pos');
              }
            });
          }
        });
      });
      $('.customize-control-wc_pdf_product_vouchers_font_style input').on('change', function(e) {
        var $btn, toggle;
        $btn = $(e.target).closest('.font-style-button');
        if ('radio' === e.target.type) {
          $btn.siblings().removeClass('active');
        }
        toggle = $(e.target).is(':checked') ? 'addClass' : 'removeClass';
        return $btn[toggle]('active');
      }).on('click', function(e) {
        var $btn;
        if ('radio' === e.target.type) {
          $btn = $(e.target).closest('.font-style-button');
          if ($btn.hasClass('active')) {
            $(e.target).removeAttr('checked');
            return $btn.removeClass('active').siblings('.font-style-text-align-empty').prop('checked', true).change();
          }
        }
      });
      $rangeSliders = $('input[type="range"]');
      if ($rangeSliders) {
        $rangeSliders.each(function() {
          return $(this).closest('label').append('<span class="wc-pdf-product-vouchers-range-index"></span>');
        });
        set_range_text = function(el) {
          var label, value;
          value = $(el).val();
          label = value > 0 ? value + 'px' : woocommerce_vouchers_admin_customizer.i18n["default"];
          return $(el).parent().find('.wc-pdf-product-vouchers-range-index').text(label);
        };
        $rangeSliders.on('input', function() {
          return set_range_text(this);
        });
        return $rangeSliders.each(function(index, el) {
          return set_range_text(el);
        });
      }
    });

    /**
    	 * Voucher Images Media Frame
    	 *
    	 * @since 3.0.0
     */
    return VoucherImagesFrame = wp.media.view.MediaFrame.Select.extend({
      bindHandlers: function() {
        wp.media.view.MediaFrame.Select.prototype.bindHandlers.apply(this, arguments);
        return this.on('content:render:defaults', this.defaultsContent, this);
      },
      browseRouter: function(routerView) {
        return routerView.set({
          upload: {
            text: _wpMediaViewsL10n.uploadFilesTitle,
            priority: 20
          },
          browse: {
            text: _wpMediaViewsL10n.mediaLibraryTitle,
            priority: 40
          },
          defaults: {
            text: _wpCustomizeHeader._pdf_vouchers.i18n.default_images_title,
            priority: 60
          }
        });
      },

      /**
      		 * Render callback for the content region in the `defaults` mode.
      		 *
      		 * This will render the tab content for the "Default Images", showing only
      		 * default voucher images.
      		 *
      		 * @param {wp.media.controller.Region} contentRegion
       */
      defaultsContent: function(contentRegion) {
        var state;
        state = this.state();
        return this.content.set(new wp.media.view.AttachmentsBrowser({
          controller: this,
          collection: state.get('defaults'),
          selection: state.get('selection'),
          model: state,
          sortable: false,
          search: false,
          filters: false,
          date: state.get('date'),
          display: state.has('display') ? state.get('display') : state.get('displaySettings'),
          dragInfo: state.get('dragInfo'),
          idealColumnWidth: state.get('idealColumnWidth'),
          suggestedWidth: state.get('suggestedWidth'),
          suggestedHeight: state.get('suggestedHeight'),
          AttachmentView: state.get('AttachmentView')
        }));
      }
    });
  })(window.wp, jQuery);

}).call(this);


